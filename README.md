# Code review

[![Build Status](https://travis-ci.org/openeuropa/code-review.svg?branch=master)](https://travis-ci.org/openeuropa/code-review)

Make automatic [conventions](CONVENTIONS.md) checking on each commit via [GrumPHP](https://github.com/phpro/grumphp).

## Installation

Install the code review component via Composer:

```
composer require --dev openeuropa/code-review
```

In your project root create the following `grumphp.yml.dist`:

```yaml
imports:
  - { resource: vendor/openeuropa/code-review/dist/library-conventions.yml }

parameters:
    extensions:
        - OpenEuropa\CodeReview\ExtraTasksExtension

```


## Customization

This component offers a variety of ready conventions that all projects need to follow.
This list of default conventions can be found in [CONVENTIONS.md](CONVENTIONS.md).

Since GrumPHP uses the [Symfony Dependency Injection component](http://symfony.com/doc/current/components/dependency_injection.html)
you can override specific parameters in your project's `grumphp.yml.dist` file as follows:

```yaml
imports:
  - { resource: vendor/openeuropa/code-review/dist/library-conventions.yml }
parameters:
  tasks.git_commit_message.matchers: ['/^JIRA-\d+: [A-Z].+\./']
```

Below the list of task parameters can that be overridden on a per-project basis:

- `tasks.phpcs.ignore_patterns`
- `tasks.phpcs.triggered_by`
- `tasks.phpcs.whitelist_patterns`
- `tasks.phpmd.exclude`
- `tasks.phpmd.ruleset`
- `tasks.phpmd.triggered_by`
- `tasks.git_commit_message.matchers`

More on how to import and override configuration files [here](http://symfony.com/doc/current/service_container/import.html).

It is also possible to extend the list of tasks to be run by adding the extra_tasks parameter
in your configuration file:

```yaml
imports:
  - { resource: vendor/openeuropa/code-review/dist/library-conventions.yml }
parameters:
  extra_tasks:
    phpparser: ~
  tasks.git_commit_message.matchers: ['/^JIRA-\d+: [A-Z].+\./']
```

GrumPHP already has a series of ready tasks that can be added out of the box.
You can find the complete list in the [GrumPHP tasks page](https://github.com/phpro/grumphp/blob/master/doc/tasks.md).

It is also possible to create your own tasks as explained in the [GrumPHP extensions page](https://github.com/phpro/grumphp/blob/master/doc/extensions.md).


## Usage

GrumPHP tasks will be ran at every commit, if you with to run them without performing a commit use the following command:

```
$ ./vendor/bin/grumphp run
```

If you want to simulate a commit message use:

```
$ ./vendor/bin/grumphp git:pre-commit
```

Check [GrumPHP documentation](https://github.com/phpro/grumphp/tree/master/doc) for more.

## Tests

Run [PHPUnit](https://phpunit.de) tests with the following command:

```
$ ./vendor/bin/phpunit
```

## Changelog

The changelog is generated using a local docker installation which installs [muccg/docker-github-changelog-generator](https://github.com/muccg/docker-github-changelog-generator)

This reads the [Github API](https://api.github.com/repos/openeuropa/code-review) for the required repository and writes the CHANGELOG.md to the root of the repository.

**Prerequisites**

- Local Docker machine running.
- A [Github Access Token](https://github.com/settings/tokens) should be generated and exported (or written to ~/.gitconfig) as `CHANGELOG_GITHUB_TOKEN=<YOUR TOKEN HERE>`  

Before tagging a new release export the following:

```
$ export CHANGELOG_GITHUB_TOKEN=<YOUR TOKEN HERE>
$ export CHANGELOG_FUTURE_RELEASE=0.1.0

```

The changelog can then be generated by running:

```
$ composer run-script changelog
```

## Troubleshooting

**GrumPHP not fired on new commits**
 
With Git 2.9+ (June 2016) you have a new option for centralizing hooks: `core.hooksPath`. In case GrumPHP is not
fired on new commits check for `core.hooksPath` global option by running:

```
$ git config --global --list
```

To unset that option run:

```
$ git config --global --unset core.hooksPath 
```

**Generate Changelog on Mac**

* Best results were gained using the [Docker app](https://docs.docker.com/docker-for-mac/install/)
* The local repo folder should be shared under Docker -> Preferences -> File sharing to enable the file to be written locally.

